#!/usr/bin/env zsh
# shellcheck shell=bash

# Exit immediately if a command exits with a non-zero status.
set -e

# Get the absolute path of the directory where the script is located
SCRIPT_DIR="${0:a:h}"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
DESTINATION_DIR="$PROJECT_ROOT/data"

# Function to display the current state of the data directory
show_data_dir() {
    echo "Current data directory contents:"
    find "$DESTINATION_DIR" -name "unicode_data*" -type f -exec ls -la {} \;
    echo ""
}

# Function to run a test case
run_test() {
    local test_name=$1
    local command=$2
    local expected=$3

    echo "========================================"
    echo "Test: $test_name"
    echo "Command: $command"
    echo "Expected: $expected"
    echo "----------------------------------------"

    eval "$command"
    show_data_dir

    echo "Test completed."
    echo "========================================"
    echo ""
}

# Make sure the script is executable
chmod +x "$SCRIPT_DIR/gen-datasets"

# Backup existing files
echo "Backing up existing data files..."
BACKUP_DIR="$PROJECT_ROOT/data/backup"
mkdir -p "$BACKUP_DIR"
cp "$DESTINATION_DIR"/unicode_data.* "$BACKUP_DIR/" 2>/dev/null || true

# Test 1: Clean cache (remove all files and run without force)
echo "Preparing for Test 1: Clean cache..."
rm -f "$DESTINATION_DIR"/unicode_data.*
run_test "Clean cache" "$SCRIPT_DIR/gen-datasets" "All formats should be generated"

# Test 2: With force flag
run_test "With force flag" "$SCRIPT_DIR/gen-datasets --force" "All formats should be regenerated"

# Test 3: With partial files (remove one file and run without force)
echo "Preparing for Test 3: Partial files..."
rm -f "$DESTINATION_DIR"/unicode_data.txt
run_test "With partial files" "$SCRIPT_DIR/gen-datasets" "Only txt format should be generated"

# Test 4: No changes needed (all files exist)
run_test "No changes needed" "$SCRIPT_DIR/gen-datasets" "No files should be generated"

# Restore backup
echo "Restoring original data files..."
cp "$BACKUP_DIR"/unicode_data.* "$DESTINATION_DIR/" 2>/dev/null || true
rm -rf "$BACKUP_DIR"

echo "All tests completed successfully!"
